import streamlit as st
from datetime import time, date

st.set_page_config(page_title="êµìœ¡ ì•ˆë‚´ë¬¸ ìƒì„±ê¸°", page_icon=":mailbox_with_mail:", layout="centered")

# ---- ë°ì´í„° (í•„ìš”í•˜ë©´ ì—¬ê¸°ë§Œ ìˆ˜ì •) -----------------------------------------
COURSES = {
    "AIDA1": {"êµ¬ì„±": "ì´ë¡ 1+í’€ì¥1ì¼", "ìœ íš¨ê¸°ê°„": "1ê°œì›”"},
    "ì…ë¬¸ í”„ë¦¬ë‹¤ì´ë²„": {"êµ¬ì„±": "ì´ë¡ 1+í’€ì¥3ì¼", "ìœ íš¨ê¸°ê°„": "3ê°œì›”"},
    "AIDA2": {"êµ¬ì„±": "ì´ë¡ 1+í’€ì¥3ì¼", "ìœ íš¨ê¸°ê°„": "3ê°œì›”"},
    "AIDA3": {"êµ¬ì„±": "ì´ë¡ +í’€ì¥4ì¼", "ìœ íš¨ê¸°ê°„": "4ê°œì›”"},
    "AIDA4": {"êµ¬ì„±": "ì´ë¡ +í’€ì¥4ì¼", "ìœ íš¨ê¸°ê°„": "6ê°œì›”"},
    "2+3 íŒ¨í‚¤ì§€": {"êµ¬ì„±": "ì´ë¡ 2+í’€ì¥6ì¼", "ìœ íš¨ê¸°ê°„": "6ê°œì›”"},
    "3+4 íŒ¨í‚¤ì§€": {"êµ¬ì„±": "ì´ë¡ 2+í’€ì¥7ì¼", "ìœ íš¨ê¸°ê°„": "8ê°œì›”"},
    "4+ê°•ì‚¬ íŒ¨í‚¤ì§€": {"êµ¬ì„±": "ë§ˆìŠ¤í„°4ì¼+ê°•ì‚¬7ì¼", "ìœ íš¨ê¸°ê°„": "1ë…„6ê°œì›”"},
}

LOCATIONS = {
    "ì˜¬íŒ": {
        "ì£¼ì†Œ": "ì„œìš¸ ì†¡íŒŒêµ¬ ì˜¬ë¦¼í”½ë¡œ 424",
        "ë§í¬": "https://cafe.naver.com/bluepebble/620",
        "ì…ì¥ë£Œ_í‰ì¼": 18000,
        "ì…ì¥ë£Œ_ì£¼ë§": 22000,
        "ì£¼ì˜": "ë§¤ìš° í¬ê³  ë³µì¡í•©ë‹ˆë‹¤ ê¼­! ì˜¤ì‹œê¸° ì „ì— ë§í¬ í™•ì¸í•´ì£¼ì„¸ìš”",
        "ë©˜íŠ¸": "ì˜¬ë¦¼í”½ê³µì› ìˆ˜ì˜ì¥ ì ìˆ˜í’€ ì…êµ¬ì—ì„œ ëµ™ê² ìŠµë‹ˆë‹¤."
    },
    "ì ì‹¤í’€": {
        "ì£¼ì†Œ": "ì„œìš¸ ì†¡íŒŒêµ¬ ì˜¬ë¦¼í”½ë¡œ 25",
        "ë§í¬": "https://cafe.naver.com/bluepebble/259",
        "ì…ì¥ë£Œ_í‰ì¼": 15000,
        "ì…ì¥ë£Œ_ì£¼ë§": 15000,
        "ì£¼ì˜": "ì˜ˆì•½í›„ ì·¨ì†Œê°€ ì–´ë µìŠµë‹ˆë‹¤.",
        "ë©˜íŠ¸": "ì ì‹¤ ì¢…í•©ìš´ë™ì¥ ì œ2ìˆ˜ì˜ì¥ ì…êµ¬ì—ì„œ ëµ™ê² ìŠµë‹ˆë‹¤."
    },
    "ì†¡ë„í’€": {
        "ì£¼ì†Œ": "ì¸ì²œ ì—°ìˆ˜êµ¬ ì¸ì²œì‹ í•­ëŒ€ë¡œ892ë²ˆê¸¸ 40 ì¸ì²œí™˜ê²½ê³µë‹¨ ì†¡ë„ìŠ¤í¬ì¸ íŒŒí¬",
        "ë§í¬": "https://ssp.eco-i.or.kr/sub/contents/default_page.asp?mNo=MA070000000",
        "ì…ì¥ë£Œ_í‰ì¼": 5000,
        "ì…ì¥ë£Œ_ì£¼ë§": 18000,
        "ì£¼ì˜": "êµ­ë¦½ ìš´ì˜(ì£¼ë§ ìˆ˜ì—… ì–´ë ¤ì›€), ë™ì‹œì…ì¥ í•„ìš”",
        "ë©˜íŠ¸": "ì†¡ë„ ì ìˆ˜í’€ ë¡œë¹„ì—ì„œ ê°•ì‚¬ë‹˜ì„ ë§Œë‚˜ì‹œë©´ ë©ë‹ˆë‹¤."
    },
    "ìˆ˜ì›í’€": {
        "ì£¼ì†Œ": "ê²½ê¸° ìˆ˜ì›ì‹œ íŒ”ë‹¬êµ¬ ì°½ë£¡ëŒ€ë¡œ210ë²ˆê¸¸ 41 (ìˆ˜ì› ìŠ¤í¬ì¸ ì•„ì¼ëœë“œ)",
        "ë§í¬": "https://www.worldcupdivingpool.com/Map",
        "ì…ì¥ë£Œ_í‰ì¼": 18000,
        "ì…ì¥ë£Œ_ì£¼ë§": 18000,
        "ì£¼ì˜": "ì…ì¥ ì‹œ ì£¼ì°¨ 3ì‹œê°„ í• ì¸ ë“±ë¡",
        "ë©˜íŠ¸": "ìˆ˜ì˜ì¥ ì…êµ¬ê°€ ì•„ë‹Œ ìŠ¤ì¿ ë²„í’€ ì…êµ¬ì—ì„œ ëµ™ê² ìŠµë‹ˆë‹¤."
    },
    "ì„±ë‚¨í’€": {
        "ì£¼ì†Œ": "ê²½ê¸° ì„±ë‚¨ì‹œ ì¤‘ì›êµ¬ ì œì¼ë¡œ 60 ì„±ë‚¨ì¢…í•©ìŠ¤í¬ì¸ ì„¼í„° Bë™ ì§€í•˜2ì¸µ",
        "ë§í¬": "https://cafe.naver.com/bluepebble/633",
        "ì…ì¥ë£Œ_í‰ì¼": 15000,
        "ì…ì¥ë£Œ_ì£¼ë§": 20000,
        "ì£¼ì˜": "ì§€í•˜2ì¸µ ì ìˆ˜í’€ ì…êµ¬ì—ì„œ ëµ™ê² ìŠµë‹ˆë‹¤.",
        "ë©˜íŠ¸": "ì„±ë‚¨ ì•„ì¿ ì•„ë¼ì¸ ì ìˆ˜í’€ ì…êµ¬ì—ì„œ ëµ™ê² ìŠµë‹ˆë‹¤."
    },
    "K26": {
        "ì£¼ì†Œ": "ê²½ê¸° ê°€í‰êµ° ì²­í‰ë©´ ê³ ì¬ê¸¸ 262-57",
        "ë§í¬": "https://k-26.com/intro/index3.php",
        "ì…ì¥ë£Œ_í‰ì¼": 33000,
        "ì…ì¥ë£Œ_ì£¼ë§": 55000,
        "ì£¼ì˜": "ì§€ê° ì‹œ ê²°ì„ ì²˜ë¦¬ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
        "ë©˜íŠ¸": "ê°€í‰ K26 1ì¸µ ë¡œë¹„ì—ì„œ ëµ™ê² ìŠµë‹ˆë‹¤."
    },
    "ë”¥ìŠ¤í…Œì´ì…˜": {
        "ì£¼ì†Œ": "ê²½ê¸° ìš©ì¸ì‹œ ì²˜ì¸êµ¬ í¬ê³¡ì ì„±ì‚°ë¡œ 523 ë”¥ìŠ¤í…Œì´ì…˜",
        "ë§í¬": "https://deepstation.kr/theme/basic/sub/location.php",
        "ì…ì¥ë£Œ_í‰ì¼": 48000,
        "ì…ì¥ë£Œ_ì£¼ë§": 66000,
        "ì£¼ì˜": "í˜„ì¥ ê·œì • ì¤€ìˆ˜",
        "ë©˜íŠ¸": "ë”¥ìŠ¤í…Œì´ì…˜ 2ì¸µì—ì„œ ëµ™ê² ìŠµë‹ˆë‹¤."
    },
    "íŒŒë¼ë‹¤ì´ë¸Œ": {
        "ì£¼ì†Œ": "ê²½ê¸°ë„ ì‹œí¥ì‹œ ê±°ë¶ì„¬ì¤‘ì•™ë¡œ 1 1ë™3ì¸µ 303í˜¸",
        "ë§í¬": "https://paradive.co.kr/About/location.php",
        "ì…ì¥ë£Œ_í‰ì¼": 45000,
        "ì…ì¥ë£Œ_ì£¼ë§": 67000,
        "ì£¼ì˜": "í‰ì¼ 5mì¡´ë§Œ ê°€ëŠ¥",
        "ë©˜íŠ¸": "íŒŒë¼ë‹¤ì´ë¸Œ 3ì¸µ ë¡œë¹„ì—ì„œ ëµ™ê² ìŠµë‹ˆë‹¤."
    },
}

INSTRUCTORS = [
    "ê¹€í˜œì§„", "í•¨í˜„ì„", "ì´ì£¼í¬", "ì‹ ê°€ì€", "ë°•ì£¼í ",
    "ë…¸ì§„ì•„", "ì„ ë™ì§„", "ì´ë™ê·œ", "ì°¨ì§„ëª…", "ê¹€ë¯¼í˜„",
    "ì¡°ì•„ë¼", "ìœ¡ì†Œì˜", "ë…¸ì§„ì•„", "ì£¼ì„ í˜•", "ê¹€ë™í¬",
    "í‘œì •ìŠ¹"
]

DEFAULT_ITEMS = "ìˆ˜ì˜ë³µ, ìˆ˜ì˜ëª¨, ìˆ˜ê±´, ì„¸ë©´ë„êµ¬"

# ---- ì‚¬ì´ë“œë°” --------------------------------------------------------------
with st.sidebar:
    st.header("ì˜µì…˜")
    show_details = st.checkbox("ê³¼ì • êµ¬ì„±/ìœ íš¨ê¸°ê°„ ë¬¸êµ¬ í¬í•¨", value=True)
    custom_items = st.text_input("ê¸°ë³¸ ì¤€ë¹„ë¬¼(ìˆ˜ì • ê°€ëŠ¥)", value=DEFAULT_ITEMS)
    add_extra = st.text_area("ì¶”ê°€ ì•ˆë‚´ë¬¸(ì„ íƒ)", placeholder="ì˜ˆ) ì‹ ë¶„ì¦ ì§€ì°¸, ë™ì‹œì…ì¥ í•„ìš” ë“±")

st.title("êµìœ¡ ì•ˆë‚´ë¬¸ ìƒì„±ê¸°")
st.caption("ë“œë¡­ë‹¤ìš´ ì„ íƒ â†’ ìë™ìœ¼ë¡œ ì•ˆë‚´ë¬¸ ì™„ì„± â†’ ë³µì‚¬/ë‹¤ìš´ë¡œë“œ")

# ---- ì…ë ¥ ì˜ì—­ --------------------------------------------------------------
col1, col2 = st.columns(2)
with col1:
    course = st.selectbox("ì‹ ì²­ ë ˆë²¨(ê³¼ì •)", options=list(COURSES.keys()))
    instr = st.selectbox("ê°•ì‚¬ëª…", options=INSTRUCTORS)
with col2:
    loc_name = st.selectbox("êµìœ¡ ì¥ì†Œ", options=list(LOCATIONS.keys()))
    dt_date = st.date_input("êµìœ¡ ë‚ ì§œ", value=date.today())
    dt_time = st.time_input("êµìœ¡ ì‹œê°„", value=time(15, 0))

name = st.text_input("êµìœ¡ìƒ ì´ë¦„(ì„ íƒ)", placeholder="ì˜ˆ) í™ê¸¸ë™")

# ---- ë°ì´í„° ê³„ì‚° ------------------------------------------------------------
loc = LOCATIONS.get(loc_name, {})
course_meta = COURSES.get(course, {})

# í•œêµ­ í˜•ì‹ ë‚ ì§œ/ì‹œê°„ (Windows í˜¸í™˜)
weekday_kr = ["ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ", "í† ", "ì¼"]
dow = weekday_kr[dt_date.weekday()]
time_str = dt_time.strftime("%H:%M")
date_kr = f"{dt_date.month}ì›” {dt_date.day}ì¼"

# í‰ì¼/ì£¼ë§ êµ¬ë¶„
is_weekend = dow in ["í† ", "ì¼"]
if is_weekend:
    fee = loc.get("ì…ì¥ë£Œ_ì£¼ë§", 0)
    fee_type = "ì£¼ë§"
else:
    fee = loc.get("ì…ì¥ë£Œ_í‰ì¼", 0)
    fee_type = "í‰ì¼"

# ë³´ê¸°ìš© êµ¬ì„±/ìœ íš¨ê¸°ê°„
course_line = ""
if show_details:
    g = course_meta.get("êµ¬ì„±", "")
    v = course_meta.get("ìœ íš¨ê¸°ê°„", "")
    parts = []
    if g:
        parts.append(f"{g}")
    if v:
        parts.append(f"êµìœ¡ì†Œì§„ìœ íš¨ê¸°ê°„: {v}")
    if parts:
        course_line = f"({', '.join(parts)})"

# ê¸ˆì•¡/ë¹ˆê°’ ì•ˆì „ ì²˜ë¦¬
fee_str = f"{fee:,}ì› ({fee_type})" if isinstance(fee, (int, float)) and fee > 0 else "í˜„ì¥ ì•ˆë‚´"

# ìˆ˜ê°•ìƒ ì´ë¦„ ë¼ì¸
name_line = f"ìˆ˜ê°•ìƒ: {name}" if name.strip() else ""

# ---- ì•ˆë‚´ë¬¸ ìƒì„± ------------------------------------------------------------
message = f"""â–¶ ì‹ ì²­ë ˆë²¨
- {course}
{course_line}

â–¶ êµìœ¡ìŠ¤ì¼€ì¤„
- {date_kr}({dow})
ì ìˆ˜í’€/ì´ë¡  ìˆ˜ì—… {time_str}

â–¶ êµìœ¡ì¥ì†Œ
{loc_name} ({loc.get('ì£¼ì†Œ','')})
ì˜¤ì‹œëŠ” ë°©ë²• {loc.get('ë§í¬','')}

â–¶ ì¤€ë¹„ë¬¼
- {custom_items}
- ì…ì¥ë£Œ {fee_str} (ìˆ˜ì—… í›„ ì•ˆë‚´)

â–¶ ê°•ì‚¬ ì—°ë½ì²˜
êµìœ¡ê°•ì‚¬: {instr}
ëŒ€í‘œë²ˆí˜¸ ë¸”ë£¨í˜ë¸” 02-6278-7787
{name_line}

ğŸ“ ì•ˆë‚´ë©˜íŠ¸
{date_kr}({dow}) {time_str}ì— {loc.get('ë©˜íŠ¸','')}
ì£¼ì˜ì‚¬í•­: {loc.get('ì£¼ì˜','')}
"""

if add_extra.strip():
    message += f"\nì¶”ê°€ ì•ˆë‚´: {add_extra.strip()}\n"

# ---- ì¶œë ¥ UI ---------------------------------------------------------------
st.subheader("ìƒì„±ëœ ì•ˆë‚´ë¬¸")
st.text_area("ì•„ë˜ ë‚´ìš© í†µì§¸ë¡œ ë³µì‚¬í•´ì„œ ë³´ë‚´ë©´ ë©ë‹ˆë‹¤.", value=message, height=360)
st.code(message, language="")  # ë³µì‚¬ ë²„íŠ¼ ì œê³µ

# ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ (txt)
st.download_button(
    label="ì•ˆë‚´ë¬¸ .txt ë‹¤ìš´ë¡œë“œ",
    data=message.encode("utf-8"),
    file_name=f"ì•ˆë‚´ë¬¸_{dt_date.isoformat()}_{loc_name}.txt",
    file_name=f"ì•ˆë‚´ë¬¸_{dt_date.isoformat()}_{loc_name}.txt",
    mime="text/plain"
)

# ë¯¸ë¦¬ë³´ê¸° ì¹´ë“œ
with st.expander("ì¥ì†Œ ìƒì„¸ ë¯¸ë¦¬ë³´ê¸°"):
    st.markdown(f"**ì£¼ì†Œ**: {loc.get('ì£¼ì†Œ','')}")
    st.markdown(f"**ë§í¬**: {loc.get('ë§í¬','')}")
    st.markdown(f"**ì…ì¥ë£Œ**: {fee_str}")
    st.markdown(f"**ì£¼ì˜ì‚¬í•­**: {loc.get('ì£¼ì˜','')}")
